{% extends "novel/layout.html" %}
{% load static %}

{% block title %}
  Genesis | {{user.username}}
{% endblock %}

{% block body %}
<div>
  <a href="{% url 'index'%}">Genesis</a> >> <span>{{user.username}}</span>
</div>
<hr>

<div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
  <div style="display: flex; flex-direction: column; justify-content: center; align-items: center;">
    <img src="{{user.image}}" style="width: 7.5rem; height: 7.5rem; border-radius: 50%; aspect-ratio: 1; object-fit: cover;" />
    <h1>{{user.username}}</h1>
  </div>
  <div>
    <button id="follow" class="btn {% if user.is_following %} btn-danger{% else %} btn-primary {% endif %}" >
    {% if user.is_following %}
      <i class="fa fa-minus" aria-hidden="true"></i>
      Unfollow
    {% else %}
      <i class="fa fa-plus" aria-hidden="true"></i>
      Follow
    {% endif %}
    </button>
  </div>
</div>
<div style="display: flex;  justify-content: space-between; align-items: center;">
  <div style="display: flex; flex-direction: column;  justify-content: space-between; align-items: center;">
    <p>Member since</p> <p><strong>{{user.date_joined}}</strong></p>
  </div>
  <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
    <p>Followers</p> <p><strong id="followers_count">{{user.followers_count}}</strong></p>
  </div>
  <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
    <p>Following</p> <p><strong id="following_count">{{user.following_count}}</strong></p>
  </div>
  <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: center;">
    <p>Comments</p> <p><strong>{{user.comments|length}}</strong></p>
  </div>
</div>

<div class="tab">
  <button class="tablinks" onclick="openCity(event, 'overview')" id="defaultOpen">Overview</button>
  <button class="tablinks" onclick="openCity(event, 'novels')">Novels</button>

  <button class="tablinks" onclick="openCity(event, 'chapters')">Chapters</button>
  <button class="tablinks" onclick="openCity(event, 'comments')">Comments ({{novel.comments}})</button>
</div>

<div id="overview" class="tabcontent">
  <div>
    <div>
      <h3><strong>Personal Information</strong></h3>
      <hr>
      <div style="display: flex; justify-content: space-between;">
        <p>Last Active:</p>
        <p>{{user.last_login}}</p>
        <p></p>        
      </div>
      <div style="display: flex; justify-content: space-between;">
        <p>Birthday:</p>
        <p>{{user.birthday}}</p>
        <p></p>        
      </div>
      <div style="display: flex; justify-content: space-between;">
        <p>Gender:</p>
        <p>{{user.gender}}</p>
        <p></p>        
      </div>
      <div style="display: flex; justify-content: space-between;">
        <p>Location:</p>
        <p>{{user.location}}</p>
        <p></p>        
      </div>


    </div>

    <div>
      <h3><strong>About</strong></h3>
      <hr>
      <p>
        {{user.about}}
      </p>

    </div>
    
    <div>
      <h3><strong>Author Information</strong></h3>
      <hr>
      <table class="table table-borderless">
        <tbody>
          <tr>
            <td>Series:</td>
            <td>{{novels|length}}</td>
            <td></td>
          </tr>
          <tr>
            <td>Total Pageviews:</td>
            <td>{{user.total_views}}</td>
            <td></td>
          </tr>
          <tr>
            <td>Total Series Comments:</td>
            <td>{{user.novel_comments}}</td>
            <td></td>
          </tr>
          
          <tr>
            <td>Reviews Received:</td>
            <td></td>
            <td></td>
          </tr>
          
          <tr>
            <td>Readers:</td>
            <td></td>
            <td></td>    
          </tr>
          <tr>
            <td>Series Followers:</td>
            <td></td>
            <td></td>
          </tr>
        </tbody>
      </table>
      
    </div>
    {% if is_own_profile %}
      <a href="{% url 'edit_profile' %}"> Edit Profile</a>
    {% endif %}
  </div>
</div>

<div id="novels" class="tabcontent">
  {% if user.is_user %}
    <table class="table table-borderless">
      <tbody>
        {% for novel in novels %}
        <tr>
          <td>
            <img class="img-responsive item-img lazy" src="{{novel.image}}" />
          </td>
          <td>
            <a>
              {{novel.title}}
            </a>
          </td>
          <td>
            <a class="">
              Edit Novel
            </a>
          </td>
          <td>
            <a class="">
            View Chapters
            </a>
          </td>
          <td>
            <a class="">
              Add Chapter
            </a>
          </td>

          <td>
            <a class="">
              Delete Novel
            </a>
          </td>
        </tr>
        {% empty %}
          {{user.username}} hasn't written anything
        {% endfor %}
        </tbody>
    </table>
  {% else %}
    {% for novel in novels %}
      <div style="border: 1px solid white; border-radius: 15px; padding: 1rem; margin-bottom: 1rem; background-color: #1e1e1e; display: flex; flex-direction: column; gap: 1rem;">
        <div style="display: flex;">
          <a href="{% url 'novel' id=novel.id %}" class="index-image">
            <img src="{{novel.image}}" class="img-responsive item-img lazy img-fluid cover" />
          </a>
          <div style="float: none">
            <a href="{% url 'novel' id=novel.id %}">
              <h4>{{novel.title}}</h4>
            </a>
            <div class="desc-text">{{novel.description | safe }}</div>
          </div>
        </div>
        
        <div>
        
        </div>

        <div style="border: 1px solid white; border: 15px; margin-top: 1rem; display: flex; justify-content: space-between; align-items: center;">
        
          <a href="{% url 'novel' id=novel.id %}" style="color: white;">
            <button class="btn btn-primary btn-sm" style="border-radius: 15px;">
            Read
            </button>
          </a>

          <a href="{% url 'novel' id=novel.id%}#comments-view" style="display: flex; align-items: center; gap: 0.25rem;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat" viewBox="0 0 16 16">
              <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"/>
            </svg>
            <span>{{novel.comments}}</span>
          </a>
        </div>
      </div>
    {% empty %}
      {{user.username}} hasn't written anything
    {% endfor %}
  {% endif %}
</div>
<script src="{% static 'novel/tabs.js' %}"></script>
<script>
  const follow = document.getElementById('follow');
  const followersCount = document.getElementById('followers_count');
  const followingCount = document.getElementById('following_count');

  follow.addEventListener('click', async () => {
    let reponse = await fetch(`/follow/{{user.username}}`);
    let data = await reponse.json();

    if (data.error) {
      alert(data.error);
      return;
    }  else if (data.follow) {
      follow.innerHTML = `
      <i class="fa fa-minus" aria-hidden="true"></i>
      Unfollow`;
    } else if (!data.follow) {
      follow.innerHTML = `
      <i class="fa fa-plus" aria-hidden="true"></i>
      Follow
      `;
    }
    follow.classList.toggle('btn-primary');
    follow.classList.toggle('btn-danger');
    followersCount.textContent = data.followersCount;
    followingCount.textContent = data.followingCount;
  });
</script>

{% endblock %}
